#! /bin/sh
# aldc: Add LaTeX DevContainer

BACKUP_TARGET='.gitignore .latexmkrc .textlintrc'
TMP_DIR='.tmp'
LATEX_ENV='latexenv'
LATEX_ENV_REPOSITORY='https://github.com/smkwlab/latex-environment.git'

if [ -d .devcontainer ]; then
  echo already added
  exit
fi

if [ ! -d .git ]; then
  git init .
  git add .
  git rm --cached aldc
  git commit -m "initial commit"
fi

case $(uname -m) in
  x86_64)
    BRANCH=alpine
    ;;
  *)
    BRANCH=main
    ;;
esac

mkdir "${TMP_DIR}"
for f in ${BACKUP_TARGET}; do
  [ -f "${f}" ] && git mv ${f} ${TMP_DIR}
done
git commit -m "aldc initialize: backup dot files to avoid conflict"

echo add LaTeX environment
git remote add "${LATEX_ENV}" "${LATEX_ENV_REPOSITORY}"
git fetch "${LATEX_ENV}"
git merge --allow-unrelated-histories -m "aldc: add latex container" "${LATEX_ENV}/${BRANCH}"
git remote remove "${LATEX_ENV}"

echo "recover dot files"
cd ${TMP_DIR}
for f in ${BACKUP_TARGET}; do
  if [ -f ${f} ]; then
    git rm ../${f}
    git mv ${f} ..
  fi
done
cd ..
rmdir "${TMP_DIR}"
git commit -m "aldc finilize: recover dot files"

if [ -d .devcontainer ]; then
  echo You can delete aldc
fi    
